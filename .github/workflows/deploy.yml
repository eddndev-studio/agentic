name: Deploy Agentic (Native)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Deploy via SSH
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          KEY_FILE=$(mktemp)
          echo "$VPS_SSH_KEY" > "$KEY_FILE"
          chmod 600 "$KEY_FILE"

          ssh -o StrictHostKeyChecking=no -i "$KEY_FILE" -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'DEPLOY'
          set -e

          echo "Starting Deployment..."

          cd /var/www/agentic

          echo "Pulling latest code..."
          git fetch --all
          git reset --hard origin/main

          echo "Building Backend..."
          cd backend
          npm install
          npx prisma migrate deploy
          npx prisma generate
          npx tsx prisma/seed.ts
          npm run build

          echo "Building Frontend..."
          cd ../frontend
          npm install
          export PUBLIC_API_URL="https://agentic-api.w-gateway.cc"
          npm run build

          echo "Restarting PM2..."
          cd ..
          pm2 startOrReload ecosystem.config.cjs

          echo "Deployment Complete!"
          DEPLOY

          rm -f "$KEY_FILE"
